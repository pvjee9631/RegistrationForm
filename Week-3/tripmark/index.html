<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tripmark v0.2 – Map Bookmarks & Notes</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j7kG1WwZP7b2C4Y2sQkG02z8J8WcJSkVbZ8Jp3s="
    crossorigin=""
  ></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --panel: #111827; /* gray-900 */
      --muted: #9ca3af; /* gray-400 */
      --text: #e5e7eb; /* gray-200 */
      --accent: #38bdf8; /* sky-400 */
      --accent-2: #22d3ee; /* cyan-400 */
      --danger: #ef4444; /* red-500 */
      --ok: #22c55e; /* green-500 */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .app { display: grid; grid-template-columns: 360px 1fr; height: 100%; }
    .sidebar { background: var(--panel); border-right: 1px solid #1f2937; display: flex; flex-direction: column; }
    .header { padding: 14px 16px; border-bottom: 1px solid #1f2937; display: flex; align-items: center; gap: 8px; }
    .header h1 { font-size: 16px; margin: 0; font-weight: 700; letter-spacing: .2px; }
    .header .actions { margin-left: auto; display: flex; gap: 8px; }
    .btn { background: #1f2937; color: var(--text); border: 1px solid #374151; padding: 6px 10px; border-radius: 10px; cursor: pointer; font-size: 12px; }
    .btn:hover { border-color: #4b5563; }
    .btn.primary { background: linear-gradient(90deg, var(--accent), var(--accent-2)); color: #0b1020; font-weight: 700; border: none; }
    .btn.danger { background: #2b1c1c; border-color: #5a2323; color: #fecaca; }

    .form { padding: 12px 16px; display: grid; gap: 8px; border-bottom: 1px solid #1f2937; }
    .form label { font-size: 12px; color: var(--muted); }
    .input, .textarea { width: 100%; background: #0b1220; border: 1px solid #23314d; color: var(--text); padding: 8px 10px; border-radius: 10px; font-size: 13px; }
    .textarea { min-height: 66px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .hint { color: var(--muted); font-size: 11px; }

    .taglist { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
    .chip { background: #111827; border: 1px solid #374151; color: var(--text); padding: 3px 8px; border-radius: 999px; font-size: 11px; cursor: pointer; }
    .chip.active { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent) inset; }

    .searchbar { padding: 8px 16px; border-bottom: 1px solid #1f2937; display: grid; gap: 8px; }
    .searchbar input { width: 100%; }

    .list { overflow: auto; padding: 8px 8px 24px; display: grid; gap: 8px; }
    .card { background: #0b1220; border: 1px solid #23314d; border-radius: 14px; padding: 10px; display: grid; gap: 6px; }
    .card h3 { font-size: 14px; margin: 0; }
    .card .meta { font-size: 11px; color: var(--muted); display: flex; gap: 8px; flex-wrap: wrap; }
    .card .thumb { width: 100%; height: 140px; object-fit: cover; border-radius: 8px; border: 1px solid #23314d; background: #0b1220; }
    .card .row { grid-template-columns: auto auto 1fr auto; align-items: center; }
    .card .tag { font-size: 11px; opacity: .85; }
    .card .toolbar { display: flex; gap: 6px; justify-content: flex-end; }

    #map { height: 100%; width: 100%; }
    .mapbar { position: absolute; z-index: 1000; top: 10px; right: 10px; display: flex; gap: 6px; }
    .toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 16px; background: #111827; border: 1px solid #374151; color: var(--text); padding: 8px 12px; border-radius: 10px; display: none; }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="header">
        <i class="fa-solid fa-location-dot"></i>
        <h1>Tripmark v0.2</h1>
        <div class="actions">
          <button id="btn-export" class="btn" title="Export JSON"><i class="fa-solid fa-file-export"></i></button>
          <label class="btn" title="Import JSON">
            <input id="import-file" type="file" accept="application/json" hidden />
            <i class="fa-solid fa-file-import"></i>
          </label>
          <button id="btn-clear" class="btn danger" title="Clear all"><i class="fa-solid fa-trash"></i></button>
        </div>
      </div>

      <form id="place-form" class="form">
        <div class="row">
          <div>
            <label>Title</label>
            <input class="input" id="f-title" placeholder="Tokyo Tower" required />
          </div>
          <div>
            <label>URL</label>
            <input class="input" id="f-url" placeholder="https://example.com" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Latitude</label>
            <input class="input" id="f-lat" placeholder="35.6586" />
          </div>
          <div>
            <label>Longitude</label>
            <input class="input" id="f-lng" placeholder="139.7454" />
          </div>
        </div>
        <div>
          <label>Tags (comma)</label>
          <input class="input" id="f-tags" placeholder="food, view, cafe" />
        </div>
        <div>
          <label>Notes</label>
          <textarea class="textarea" id="f-notes" placeholder="Best time: sunset. Ticket ¥1200..."></textarea>
        </div>
        <div>
          <label>Photo (optional)</label>
          <input class="input" id="f-photo" type="file" accept="image/*" />
          <div class="hint">Small images recommended. Stored locally (base64).</div>
        </div>
        <div class="row">
          <button type="submit" class="btn primary"><i class="fa-solid fa-plus"></i> Add / Update</button>
          <button type="button" id="btn-reset" class="btn"><i class="fa-solid fa-rotate"></i> Reset</button>
        </div>
        <input type="hidden" id="f-id" />
      </form>

      <div class="searchbar">
        <input class="input" id="q" placeholder="Search title, notes, url…" />
        <div id="tag-filters" class="taglist"></div>
      </div>

      <div id="list" class="list"></div>
    </aside>

    <main style="position: relative;">
      <div id="map"></div>
      <div class="mapbar">
        <button id="btn-locate" class="btn" title="Go to my location"><i class="fa-solid fa-crosshairs"></i></button>
        <button id="btn-drop" class="btn" title="Drop pin at center"><i class="fa-solid fa-map-pin"></i></button>
      </div>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // --- Utilities ---
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const toast = (msg) => { const t = $('#toast'); t.textContent = msg; t.style.display = 'block'; setTimeout(()=> t.style.display='none', 1400); };

    const storageKey = 'tripmark.v0.2.items';
    const items = load();

    function uid() { return 'id-' + Math.random().toString(36).slice(2, 9); }
    function nowISO() { return new Date().toISOString(); }

    function load() { try { return JSON.parse(localStorage.getItem(storageKey)) || []; } catch { return []; } }
    function save() { localStorage.setItem(storageKey, JSON.stringify(items)); renderList(); renderTagFilters(); }

    function parseTags(input) {
      return input.split(',').map(s=>s.trim()).filter(Boolean).map(s=>s.toLowerCase());
    }

    // --- Map ---
    const map = L.map('map').setView([35.6762, 139.6503], 10); // Tokyo default
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

    const markers = new Map();
    function ensureMarker(it) {
      let m = markers.get(it.id);
      const html = `<b>${escapeHtml(it.title)}</b><br/><small>${it.tags.map(t=>`#${escapeHtml(t)}`).join(' ')}</small>`;
      if (!m) {
        m = L.marker([it.lat, it.lng]).addTo(map);
        markers.set(it.id, m);
      }
      m.setLatLng([it.lat, it.lng]).bindPopup(html);
      return m;
    }

    function flyToItem(it) {
      const m = ensureMarker(it);
      map.flyTo([it.lat, it.lng], Math.max(map.getZoom(), 14), { duration: 0.75 });
      setTimeout(()=> m.openPopup(), 800);
    }

    map.on('click', (e) => {
      $('#f-lat').value = e.latlng.lat.toFixed(6);
      $('#f-lng').value = e.latlng.lng.toFixed(6);
      $('#f-title').focus();
    });

    $('#btn-locate').onclick = () => {
      map.locate({ setView: true, maxZoom: 14 });
    };

    $('#btn-drop').onclick = () => {
      const c = map.getCenter();
      $('#f-lat').value = c.lat.toFixed(6);
      $('#f-lng').value = c.lng.toFixed(6);
      toast('Coordinates filled from map center');
    };

    // --- CRUD ---
    $('#place-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = $('#f-id').value || uid();
      const title = $('#f-title').value.trim();
      const url = $('#f-url').value.trim();
      const lat = parseFloat($('#f-lat').value);
      const lng = parseFloat($('#f-lng').value);
      const tags = parseTags($('#f-tags').value);
      const notes = $('#f-notes').value.trim();

      if (!title || Number.isNaN(lat) || Number.isNaN(lng)) {
        toast('Please fill Title and valid coordinates.');
        return;
      }

      let photoData = null;
      const file = $('#f-photo').files[0];
      if (file) photoData = await fileToDataUrl(file, 1024, 1024);

      const existingIdx = items.findIndex(x => x.id === id);
      const payload = { id, title, url, lat, lng, tags, notes, photoData, updatedAt: nowISO(), createdAt: existingIdx>=0 ? items[existingIdx].createdAt : nowISO() };
      if (existingIdx >= 0) items[existingIdx] = { ...items[existingIdx], ...payload };
      else items.push(payload);

      save();
      ensureMarker(payload);
      flyToItem(payload);
      toast(existingIdx>=0 ? 'Updated ✅' : 'Added ✅');
      resetForm();
    });

    $('#btn-reset').onclick = resetForm;
    function resetForm(){
      $('#place-form').reset();
      $('#f-id').value = '';
      $('#f-title').focus();
    }

    function editItem(id){
      const it = items.find(x=>x.id===id); if(!it) return;
      $('#f-id').value = it.id;
      $('#f-title').value = it.title;
      $('#f-url').value = it.url || '';
      $('#f-lat').value = it.lat;
      $('#f-lng').value = it.lng;
      $('#f-tags').value = (it.tags||[]).join(', ');
      $('#f-notes').value = it.notes || '';
      $('#f-photo').value = '';
      flyToItem(it);
      toast('Loaded for edit');
    }

    function deleteItem(id){
      const i = items.findIndex(x=>x.id===id); if(i<0) return;
      items.splice(i,1);
      save();
      const m = markers.get(id); if (m) { map.removeLayer(m); markers.delete(id); }
      renderList();
      toast('Deleted');
    }

    // --- Export / Import / Clear ---
    $('#btn-export').onclick = () => {
      const data = JSON.stringify(items, null, 2);
      downloadFile('tripmark-export.json', data);
    };

    $('#import-file').addEventListener('change', async (e) => {
      const file = e.target.files[0]; if(!file) return;
      try {
        const text = await file.text();
        const arr = JSON.parse(text);
        if (!Array.isArray(arr)) throw new Error('Invalid format');
        // Merge by id (update existing, add new)
        const byId = new Map(items.map(x=>[x.id,x]));
        for (const it of arr) byId.set(it.id || uid(), { ...byId.get(it.id), ...it });
        const merged = Array.from(byId.values());
        items.length = 0; items.push(...merged);
        save();
        syncMarkers();
        toast('Imported ✅');
        e.target.value = '';
      } catch (err) { toast('Import failed'); }
    });

    $('#btn-clear').onclick = () => {
      if (!confirm('Delete ALL local items?')) return;
      items.length = 0; save(); syncMarkers(); renderList(); toast('Cleared');
    };

    function syncMarkers(){
      // Remove markers that no longer exist
      for (const [id, m] of markers.entries()) {
        if (!items.find(x=>x.id===id)) { map.removeLayer(m); markers.delete(id); }
      }
      // Ensure markers for items
      for (const it of items) ensureMarker(it);
    }

    function downloadFile(name, content){
      const blob = new Blob([content], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = name; a.click(); URL.revokeObjectURL(a.href);
    }

    // --- Search & Filter ---
    let activeTag = null;
    $('#q').addEventListener('input', renderList);

    function renderTagFilters(){
      const el = $('#tag-filters');
      el.innerHTML = '';
      const tags = new Set();
      for (const it of items) for (const t of (it.tags||[])) tags.add(t);
      const all = Array.from(tags).sort();
      if (!all.length) return;
      const clearBtn = document.createElement('span');
      clearBtn.className = 'chip' + (!activeTag ? ' active' : '');
      clearBtn.textContent = 'All';
      clearBtn.onclick = ()=>{ activeTag=null; renderList(); renderTagFilters(); };
      el.appendChild(clearBtn);
      for (const t of all){
        const chip = document.createElement('span');
        chip.className = 'chip' + (activeTag===t ? ' active' : '');
        chip.textContent = '#' + t;
        chip.onclick = ()=>{ activeTag = (activeTag===t ? null : t); renderList(); renderTagFilters(); };
        el.appendChild(chip);
      }
    }

    function matchesQuery(it, q){
      if (!q) return true;
      q = q.toLowerCase();
      return (
        it.title.toLowerCase().includes(q) ||
        (it.notes||'').toLowerCase().includes(q) ||
        (it.url||'').toLowerCase().includes(q) ||
        (it.tags||[]).some(t => t.includes(q))
      );
    }

    function matchesTag(it){
      if (!activeTag) return true;
      return (it.tags||[]).includes(activeTag);
    }

    function renderList(){
      const q = $('#q').value.trim().toLowerCase();
      const list = $('#list');
      list.innerHTML='';
      const filtered = items
        .filter(it=>matchesQuery(it,q) && matchesTag(it))
        .sort((a,b)=> new Date(b.updatedAt) - new Date(a.updatedAt));

      for (const it of filtered){
        const card = document.createElement('div');
        card.className = 'card';
        const title = document.createElement('h3');
        title.textContent = it.title;
        card.appendChild(title);

        const meta = document.createElement('div');
        meta.className = 'meta';
        const dt = new Date(it.updatedAt);
        meta.innerHTML = `<span><i class=\"fa-regular fa-clock\"></i> ${dt.toLocaleString()}</span>` +
                         `<span><i class=\"fa-solid fa-location-crosshairs\"></i> ${it.lat.toFixed(4)}, ${it.lng.toFixed(4)}</span>`;
        card.appendChild(meta);

        if (it.photoData){
          const img = document.createElement('img');
          img.src = it.photoData; img.alt = it.title; img.className = 'thumb';
          card.appendChild(img);
        }

        if (it.notes){
          const p = document.createElement('div'); p.textContent = it.notes; p.style.fontSize = '12px'; p.style.opacity = .9; card.appendChild(p);
        }

        const tagRow = document.createElement('div'); tagRow.className = 'taglist';
        for (const t of (it.tags||[])){
          const span = document.createElement('span'); span.className = 'chip tag'; span.textContent = '#' + t; span.onclick = ()=>{ activeTag = t; renderList(); renderTagFilters(); };
          tagRow.appendChild(span);
        }
        if (it.url){
          const a = document.createElement('a'); a.href = it.url; a.target = '_blank'; a.rel = 'noopener'; a.textContent = 'Open link ↗'; a.style.fontSize='12px'; a.style.textDecoration='none'; a.style.opacity=.9; a.style.borderBottom='1px dashed #334155';
          tagRow.appendChild(a);
        }
        card.appendChild(tagRow);

        const toolbar = document.createElement('div'); toolbar.className = 'toolbar row';
        const left = document.createElement('div'); left.style.display='flex'; left.style.gap='8px'; left.style.alignItems='center';
        const btnFocus = button(`<i class=\"fa-solid fa-location-arrow\"></i> Focus`); btnFocus.onclick = ()=> flyToItem(it); left.appendChild(btnFocus);
        const btnEdit = button(`<i class=\"fa-regular fa-pen-to-square\"></i> Edit`); btnEdit.onclick = ()=> editItem(it.id); left.appendChild(btnEdit);
        const spacer = document.createElement('div');
        const btnDelete = button(`<i class=\"fa-regular fa-trash-can\"></i> Delete`, 'danger'); btnDelete.onclick = ()=> deleteItem(it.id);
        toolbar.appendChild(left); toolbar.appendChild(spacer); toolbar.appendChild(btnDelete);
        card.appendChild(toolbar);

        list.appendChild(card);
      }
    }

    function button(html, variant){
      const b = document.createElement('button'); b.className = 'btn' + (variant?(' '+variant):''); b.innerHTML = html; return b;
    }

    function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    async function fileToDataUrl(file, maxW=1024, maxH=1024){
      // downscale image for storage efficiency
      const data = await file.arrayBuffer();
      const blob = new Blob([data]);
      const img = await blobToImage(blob);
      const scale = Math.min(1, maxW / img.width, maxH / img.height);
      const canvas = document.createElement('canvas');
      canvas.width = Math.max(1, Math.round(img.width * scale));
      canvas.height = Math.max(1, Math.round(img.height * scale));
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL('image/jpeg', 0.85);
    }

    function blobToImage(blob){
      return new Promise((resolve,reject)=>{
        const url = URL.createObjectURL(blob);
        const img = new Image();
        img.onload = ()=>{ URL.revokeObjectURL(url); resolve(img); };
        img.onerror = reject; img.src = url;
      });
    }

    // Initial
    syncMarkers();
    renderList();
    renderTagFilters();
  </script>
</body>
</html>
